---
---
最近在做云服务监控方面的工作，听起来很牛吧。其实，其实就是调用一些第三方虚拟化平台的API，获取虚拟机各方面的参数，然后在界面展示出来。呵呵。 
现在呢遇到一个问题。比如在监控平台上对虚拟机做启动，关机等操作，这个操作可能会耗时很长，让用户一直等着肯定不行。如果虚拟化平台的客户端支持异步回调，那这个功能就是小case呀。但是现实是残酷的。所以只能自己写一个针对这类操作的调度小框架了。

首先明确中心目的：**做针对”需要监控状态的任务“的调度框架**。 
我们暂且叫这种任务为”需要监控状态的任务“吧，不知道该怎么表示啦。


简单列下主要需求： 
> 1. 框架提供任务的增删改查服务，需要持久化任务信息 
> 2. 框架内部完成任务调度工作 
> 3. 框架提供任务从未执行->执行->监控->完成各阶段的流程转化


接下来做一下简单的设计。如图。
![design]({{ site.url }}/assets/20170723/design.png)
 
TaskService负责任务的增删改查，主要和db打交到。Schedule从db取出为执行完成的任务，开始调度，相当于指挥官。TaskHandler是具体执行任务的工作者，控制任务的生命周期转化。呵呵。就是这么简单。


有没有感觉，上面那个图太简单了？直接一个需求对应一个模块，也太没有水准了吧。嘻嘻。别急，上面只是一个轮廓，要保证框架好用，并有一定弹性，还需要过一下框架设计的基本原则。在下才疏学浅，只选择了两个方面做了思考：扩展性和容错性。 

关于扩展性，想了以下几个问题： 
> 1. 要不要支持支持分布式调度？ 
> 2. 需不需要支持任务多优先级调度？ 

关于容错性，也想了几个问题： 
> 3. 如果某种情况下无法监测确定任务状态，该怎么办？ 
> 4. 如果任务执行慢，阻塞了其他任务的正常执行，怎么办？ 
关于这些问题的思考花了很长时间，其实也是一个权衡取舍的过程，自己体会吧。最终决定是，本版本解决3和4问题，因为这个会直接程序稳定性。问题2可以放入下一个版本优化。问题1先不考虑，因为用户量少，任务少，完全用不到。问题都考虑完了，发现之前那个简单的框架根本不用做修改。应证了那句话，"简单的也许是最好的。"


框架搭起来了，接下来要把每个模块内部的逻辑搞通。

先看添加任务模块，流程如图。 
![task]({{ site.url }}/assets/20170723/task.png)
TaskA是具体的任务类型，继承Task。因为数据库用的是mysql，表结构要固定，所以统一存储Task类型。这里就有一个具体任务类型和Task类型之间的转化的问题。有两种方案，一种是任务转化在使用方完成，另一种方案是在框架内部完成。选择哪种方案呢？必须是第二种呀，这样就转化过程就对用户透明了。这里选择使用json做具体任务的序列化，然后存入Task中的一个扩展字段。如果使用的是mongodb数据库，这些都不用苦恼了，因为它支持不同格式的数据存储在一个表中。

然后看下调度框架，这里借鉴了主流任务调度框架的设计。流程图如下。 
![schedule]({{ site.url }}/assets/20170723/schedule.png)

最后看下任务处理者，它是一个抽象类，提供任务执行的流程控制，和任务状态的改变。流程图如下。 
![handler]({{ site.url }}/assets/20170723/handler.png)

至此，一个小小的“需要监测状态的任务”框架就完成了。
